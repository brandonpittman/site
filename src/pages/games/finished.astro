---
import { getCollection } from "astro:content";

import Layout from "@layouts/Layout.astro";

import "core-js/proposals/array-grouping-v2";

let games = await getCollection("games");

let isFinished = (b) => !!b.data.completed;

let finished = games.filter(isFinished);

let url = new URL(Astro.url);
let searchParams = url.searchParams;
let q = searchParams.get("q")?.trim();

if (q) {
  let regex = new RegExp(q, "i");
  finished = finished.filter(
    (v) =>
      v.data.title.match(regex) ||
      v.data?.genre?.match(regex) ||
      v.data?.platform?.match(regex)
  );
}

let grouped = finished
  .sort((a, b) => (a.data.completed < b.data.completed ? -1 : 1))
  .reverse();
---

<Layout title="Finished - Brandon Pittman">
  <main class="region wrapper prose flow">
    <h1>Finished</h1>
    <form>
      <label for="search" class="visually-hidden">Title</label>
      <div class="cluster gutter-2xs" style="--align: stretch">
        <input
          id="search"
          type="search"
          name="q"
          placeholder="Search by title, genre, or platformâ€¦"
          style="inline-size: var(--size-14)"
        />
        <button type="submit" class="cta">Search</button>
      </div>
    </form>
    <ul class="flow">
      {
        grouped.map((book) => (
          <li class="flow-3xs">
            <a href={`/games/${book.slug}`}>{book.data.title}</a>
          </li>
        ))
      }
    </ul>
  </main>
</Layout>

<style>
  main {
    flex: 1 1 0%;
  }

  li > a {
    --gutter: var(--space-xs);
  }

  /* details > ul {
    margin-block-start: 1rem;
  }

  summary {
    @media (min-width: 640px) {
      inline-size: 11rem;
      text-align: end;
    }
  } */
</style>
